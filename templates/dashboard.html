<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GASsight Dashboard</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body { background: #f4f6f9; }
        .map-container {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
        }
        .filter-card {
            border-radius: 12px;
            padding: 20px;
            background: white;
            box-shadow: 0 0 10px #0001;
        }
        .table-photo {
            width: 55px;
            height: 55px;
            border-radius: 8px;
            object-fit: cover;
        }
        .badge-gas { background:#097a00; }
        .badge-rbb { background:#ce0000; }
        .badge-other { background:#6c757d; }
    </style>
</head>
<body>

<div class="container py-4">

    <h2 class="fw-bold text-success mb-4">GASsight Admin Dashboard</h2>

    <!-- FILTERS -->
    <div class="filter-card">

        <div class="row g-3">
            <div class="col-md-3">
                <label>Province</label>
                <select id="provinceFilter" class="form-select">
                    <option>All</option>
                </select>
            </div>

            <div class="col-md-3">
                <label>Municipality</label>
                <select id="municipalityFilter" class="form-select">
                    <option>All</option>
                </select>
            </div>

            <div class="col-md-3">
                <label>Barangay</label>
                <select id="barangayFilter" class="form-select">
                    <option>All</option>
                </select>
            </div>

            <div class="col-md-3">
                <label>Severity</label>
                <select id="severityFilter" class="form-select">
                    <option>All</option>
                    <option>Low</option>
                    <option>Medium</option>
                    <option>High</option>
                </select>
            </div>

            <!-- NEW: AUTOMATED INFESTATION TYPE FILTER -->
            <div class="col-md-3">
                <label>Infestation Type</label>
                <select id="infestationFilter" class="form-select">
                    <option>All</option>
                    <option>Golden Apple Snail (GAS)</option>
                    <option>Rice Black Bug (RBB)</option>
                    <option>Armyworm</option>
                    <option>Rodents</option>
                    <option>Others</option>
                </select>
            </div>

            <div class="col-md-3">
                <label>Start Date</label>
                <input type="date" id="startDate" class="form-control">
            </div>

            <div class="col-md-3">
                <label>End Date</label>
                <input type="date" id="endDate" class="form-control">
            </div>

            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-success w-100" onclick="loadReports()">Apply Filter</button>
            </div>
        </div>

    </div>

    <!-- MAP -->
    <div class="map-container" id="reportMap"></div>

    <!-- TABLE -->
    <div class="mt-4">
        <div class="card">
            <div class="card-header fw-bold">Reports</div>
            <div class="card-body p-0">
                
                <table class="table table-striped table-hover m-0">
                    <thead class="table-success">
                        <tr>
                            <th>Date</th>
                            <th>Reporter</th>
                            <th>Location</th>
                            <th>Severity</th>
                            <th>Infestation</th>
                            <th>Photo</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody"></tbody>
                </table>

            </div>
        </div>
    </div>

</div>

<script>
    let map = L.map("reportMap").setView([12.8797, 121.7740], 6);
    let markersLayer = L.layerGroup().addTo(map);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
    }).addTo(map);

    window.onload = () => { loadProvinces(); loadReports(); };

    function loadProvinces() {
        fetch('/api/provinces')
            .then(r => r.json())
            .then(data => {
                let provSel = document.getElementById("provinceFilter");
                data.forEach(p => provSel.innerHTML += `<option>${p}</option>`);
            });
    }

    // Populate municipalities when province changes
    document.getElementById("provinceFilter").addEventListener("change", () => {
        fetch(`/api/municipalities?province=${provinceFilter.value}`)
            .then(r => r.json())
            .then(data => {
                municipalityFilter.innerHTML = "<option>All</option>";
                barangayFilter.innerHTML = "<option>All</option>";
                data.forEach(m => municipalityFilter.innerHTML += `<option>${m}</option>`);
            });
    });

    document.getElementById("municipalityFilter").addEventListener("change", () => {
        fetch(`/api/barangays?municipality=${municipalityFilter.value}`)
            .then(r => r.json())
            .then(data => {
                barangayFilter.innerHTML = "<option>All</option>";
                data.forEach(b => barangayFilter.innerHTML += `<option>${b}</option>`);
            });
    });

    function loadReports() {

        let params = new URLSearchParams({
            province: provinceFilter.value,
            municipality: municipalityFilter.value,
            barangay: barangayFilter.value,
            severity: severityFilter.value,
            infestation_type: infestationFilter.value,
            start_date: startDate.value,
            end_date: endDate.value
        });

        fetch(`/api/reports?${params.toString()}`)
            .then(r => r.json())
            .then(data => {
                renderTable(data);
                renderMap(data);
            });
    }

    function renderTable(reports) {
        let body = document.getElementById("reportTableBody");
        body.innerHTML = "";

        reports.forEach(r => {
            body.innerHTML += `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.reporter}</td>
                    <td>${r.barangay}, ${r.municipality}, ${r.province}</td>
                    <td><span class="badge bg-warning">${r.severity}</span></td>
                    <td><span class="badge bg-info">${r.infestation_type || "N/A"}</span></td>
                    <td>
                        ${r.photo ? `<img src="${r.photo}" class="table-photo">` : "No Photo"}
                    </td>
                </tr>
            `;
        });
    }

    function renderMap(reports) {
        markersLayer.clearLayers();

        reports.forEach(r => {
            if (!r.lat || !r.lng) return;

            let marker = L.marker([r.lat, r.lng]).addTo(markersLayer);

            marker.bindPopup(`
                <b>${r.infestation_type}</b><br>
                <b>${r.severity}</b> severity<br><br>
                <b>${r.barangay}, ${r.municipality}</b><br>
                ${r.province}<br><br>
                <img src="${r.photo}" width="120" style="border-radius:6px;">
            `);
        });
    }
</script>

</body>
</html>
