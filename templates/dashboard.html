<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GASsight Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

    <style>
        body { background: #f5f5f5; }

        /* KPI Cards with different colors */
        .kpi-card {
            border-radius: 12px;
            padding: 18px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 6px solid #198754;
        }
        .kpi-red { border-left-color:#dc3545; }
        .kpi-yellow { border-left-color:#ffc107; }
        .kpi-blue { border-left-color:#0d6efd; }

        #map { 
            height: 430px; 
            border-radius: 10px; 
        }

        .panel-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #dc3545;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Severity badge colors */
        .severity-pending { 
            background-color: #6c757d !important; 
            color: white !important;
        }
        .severity-low { 
            background-color: #28a745 !important; 
            color: white !important;
        }
        .severity-moderate { 
            background-color: #ffc107 !important; 
            color: black !important;
        }
        .severity-high { 
            background-color: #fd7e14 !important; 
            color: white !important;
        }
        .severity-critical { 
            background-color: #dc3545 !important; 
            color: white !important;
        }

        /* Profile button styling */
        .profile-btn {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: white;
            border: 2px solid #0d6efd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-btn:hover {
            background: #0d6efd;
            color: white;
        }

        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        /* Action buttons */
        .action-btn-group {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .btn-delete {
            background-color: #dc3545;
            border: none;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background-color: #c82333;
            transform: scale(1.05);
        }

        .btn-severity {
            background-color: #0d6efd;
            border: none;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-severity:hover {
            background-color: #0b5ed7;
            transform: scale(1.05);
        }
    </style>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Heatmap plugin -->
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center px-3 py-2 bg-white shadow-sm border-bottom sticky-top" style="z-index: 1000;">
    <div class="d-flex align-items-center">
        <img src="/static/images/snail-logo.png" style="height:55px;width:55px;border-radius:50%;object-fit:cover;">
        <div class="ms-2">
            <h4 class="fw-bold m-0">GASsight Dashboard</h4>
            <small class="text-muted">Golden Apple Snail Infestation Tracking &amp; Visualization</small>
        </div>
    </div>

    <div class="text-end d-flex align-items-center gap-3">
        <div class="small text-muted">
            Last updated: <span id="lastUpdate" class="fw-semibold">--:--:--</span>
        </div>

        <div class="d-flex gap-2">
            <button id="manualRefresh" class="btn btn-outline-primary btn-sm">Refresh Now</button>
            <select id="refreshInterval" class="form-select form-select-sm w-auto">
                <option value="off">Auto-refresh: Off</option>
                <option value="10">Every 10s</option>
                <option value="30">Every 30s</option>
                <option value="60">Every 1m</option>
            </select>
            
            <!-- Profile Button -->
            <button id="profileBtn" class="profile-btn btn-sm">
                <div class="profile-avatar" id="profileAvatar">?</div>
                <span id="profileName">Profile</span>
            </button>
            
            <a href="/logout" class="btn btn-danger btn-sm">Logout</a>
        </div>
    </div>
</div>


<!-- KPI CARDS -->
<div class="container mt-3">
    <div class="row g-3">
        <div class="col-md-3">
            <div class="kpi-card">
                <h6>Total Sightings</h6>
                <h2 id="totalSightings" class="fw-bold">0</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card kpi-red">
                <h6>High-Risk Hotspots</h6>
                <h2 id="activeHotspots" class="fw-bold">0</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card kpi-yellow">
                <h6>Active Reporters</h6>
                <h2 id="activeReporters" class="fw-bold">0</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card kpi-blue">
                <h6>Avg Response (hrs)</h6>
                <h2 id="avgResponse" class="fw-bold">0</h2>
            </div>
        </div>
    </div>
</div>


<!-- FILTERS -->
<div class="container mt-4">
    <div class="row g-3">
        <div class="col-md-2">
            <label class="form-label">Province</label>
            <select id="provinceFilter" class="form-select"></select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Municipality</label>
            <select id="municipalityFilter" class="form-select"></select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Barangay</label>
            <select id="barangayFilter" class="form-select"></select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Severity</label>
            <select id="severityFilter" class="form-select">
                <option value="All">All</option>
                <option value="Pending">Pending</option>
                <option value="Low">Low</option>
                <option value="Moderate">Moderate</option>
                <option value="High">High</option>
                <option value="Critical">Critical</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Infestation Type</label>
            <select id="infestationFilter" class="form-select">
                <option value="All">All</option>
                <option value="Golden Apple Snail (GAS)">Golden Apple Snail (GAS)</option>
                <option value="Rice Black Bug (RBB)">Rice Black Bug (RBB)</option>
                <option value="Brown Plant Hopper (BPH)">Brown Plant Hopper (BPH)</option>
                <option value="Others">Others</option>
            </select>
        </div>
    </div>

    <div class="row g-3 mt-2">
        <div class="col-md-2">
            <label class="form-label">Start Date</label>
            <input id="startDate" type="date" class="form-control">
        </div>
        <div class="col-md-2">
            <label class="form-label">End Date</label>
            <input id="endDate" type="date" class="form-control">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button id="filterBtn" class="btn btn-success w-100">Apply</button>
        </div>
    </div>
</div>


<!-- HEATMAP PANEL -->
<div class="container mt-4">
    <div class="panel-box">
        <h5 class="fw-bold mb-3">Infestation Heatmap</h5>
        <div id="map"></div>
    </div>
</div>


<!-- CHARTS -->
<div class="container mt-4">
    <div class="row g-3">
        <div class="col-md-4">
            <div class="chart-box">
                <h6 class="fw-bold mb-2">Severity Distribution</h6>
                <canvas id="severityChart"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-box">
                <h6 class="fw-bold mb-2">Reports by Barangay</h6>
                <canvas id="barangayChart"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-box">
                <h6 class="fw-bold mb-2">Weekly Trend</h6>
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
</div>


<!-- RECENT REPORTS TABLE -->
<div class="container mt-4">
    <div class="chart-box">
        <h5 class="fw-bold mb-3">Recent Reports</h5>
        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Photo</th>
                        <th>Date</th>
                        <th>Province</th>
                        <th>Municipality</th>
                        <th>Barangay</th>
                        <th>Severity</th>
                        <th>Infestation Type</th>
                        <th>Reporter</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recentReportsTable">
                    <tr><td colspan="9" class="text-center text-muted">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- FULL IMAGE MODAL -->
<div class="modal fade" id="photoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body p-0">
        <img id="modalPhoto" src="" class="w-100" style="border-radius:4px;">
      </div>
    </div>
  </div>
</div>


<!-- EDIT SEVERITY MODAL -->
<div class="modal fade" id="severityModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update Severity</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">
          <strong>Location:</strong>
          <span id="severityLocation"></span>
        </p>
        <div class="mb-3">
          <label for="severitySelect" class="form-label fw-bold">Severity</label>
          <select id="severitySelect" class="form-select">
            <option value="Pending">Pending</option>
            <option value="Low">Low</option>
            <option value="Moderate">Moderate</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
        </div>
        <div id="severityError" class="alert alert-danger py-2 px-3 d-none small"></div>
        <input type="hidden" id="severityReportId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary btn-sm" onclick="saveSeverity()">Save</button>
      </div>
    </div>
  </div>
</div>


<!-- PROFILE MODAL -->
<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">User Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <div class="profile-avatar mx-auto" id="profileModalAvatar" style="width:80px;height:80px;font-size:32px;">?</div>
          <h5 class="mt-2" id="profileModalName">Loading...</h5>
        </div>
        
        <div class="row g-2">
          <div class="col-6">
            <small class="text-muted">Username:</small>
            <p class="fw-bold" id="profileUsername">-</p>
          </div>
          <div class="col-6">
            <small class="text-muted">Email:</small>
            <p class="fw-bold" id="profileEmail">-</p>
          </div>
          <div class="col-6">
            <small class="text-muted">Phone:</small>
            <p class="fw-bold" id="profilePhone">-</p>
          </div>
          <div class="col-6">
            <small class="text-muted">Role:</small>
            <p class="fw-bold" id="profileRole">-</p>
          </div>
          <div class="col-12">
            <small class="text-muted">Address:</small>
            <p class="fw-bold" id="profileAddress">-</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- DELETE CONFIRMATION MODAL -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">⚠️ Delete Report</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this report?</p>
        <p class="text-muted small mb-0">This action cannot be undone.</p>
        <input type="hidden" id="deleteReportId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>


<!-- FOOTER -->
<div class="text-center text-muted p-3 mt-4">
    © 2025 GASsight | Dashboard System
</div>

<script>
// GLOBAL VARIABLES
let map;
let heatLayer;
let markersLayer = L.layerGroup();
window.allReports = [];
window.userProfile = null;

let severityChart, barangayChart, trendChart;
let autoRefreshTimer = null;

// SEVERITY COLOR MAPPING
const SEVERITY_COLORS = {
    'Pending': { badge: 'severity-pending', marker: '#6c757d' },
    'Low': { badge: 'severity-low', marker: '#28a745' },
    'Moderate': { badge: 'severity-moderate', marker: '#ffc107' },
    'High': { badge: 'severity-high', marker: '#fd7e14' },
    'Critical': { badge: 'severity-critical', marker: '#dc3545' }
};

// LOAD USER PROFILE
async function loadUserProfile() {
    try {
        const res = await fetch("/api/profile");
        if (!res.ok) {
            console.error("Failed to load profile");
            return;
        }

        window.userProfile = await res.json();
        
        const name = window.userProfile.full_name || window.userProfile.username || "User";
        const initials = getInitials(name);
        
        document.getElementById("profileAvatar").textContent = initials;
        document.getElementById("profileName").textContent = name.split(' ')[0];
        
    } catch (err) {
        console.error("Error loading profile:", err);
    }
}

// GET INITIALS FROM NAME
function getInitials(name) {
    if (!name) return "?";
    const parts = name.trim().split(' ');
    if (parts.length === 1) return parts[0][0].toUpperCase();
    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
}

// SHOW PROFILE MODAL
function showProfileModal() {
    if (!window.userProfile) {
        alert("Profile not loaded yet");
        return;
    }

    const profile = window.userProfile;
    const name = profile.full_name || profile.username || "Unknown";
    const initials = getInitials(name);

    document.getElementById("profileModalAvatar").textContent = initials;
    document.getElementById("profileModalName").textContent = name;
    document.getElementById("profileUsername").textContent = profile.username || "-";
    document.getElementById("profileEmail").textContent = profile.email || "-";
    document.getElementById("profilePhone").textContent = profile.phone || profile.contact || "-";
    document.getElementById("profileRole").textContent = profile.is_admin ? "Admin" : "User";
    document.getElementById("profileAddress").textContent = profile.address || "-";

    const modal = new bootstrap.Modal(document.getElementById("profileModal"));
    modal.show();
}

// INIT MAP
function initMap() {
    map = L.map("map").setView([17.25, 120.45], 9);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    markersLayer.addTo(map);
}

// LOAD FILTER DROPDOWNS WITH CASCADING BEHAVIOR
async function loadFilterDropdowns() {
    const provinceSelect = document.getElementById("provinceFilter");
    const municipalitySelect = document.getElementById("municipalityFilter");
    const barangaySelect = document.getElementById("barangayFilter");

    provinceSelect.innerHTML = `<option value="All">All Provinces</option>`;
    municipalitySelect.innerHTML = `<option value="All">All Municipalities</option>`;
    barangaySelect.innerHTML = `<option value="All">All Barangays</option>`;
    
    municipalitySelect.disabled = true;
    barangaySelect.disabled = true;

    try {
        const provinceRes = await fetch("/api/locations/provinces");
        const provinceData = await provinceRes.json();
        
        if (provinceData.provinces) {
            provinceData.provinces.forEach(province => {
                provinceSelect.innerHTML += `<option value="${province}">${province}</option>`;
            });
        }

        provinceSelect.addEventListener("change", async function() {
            const selectedProvince = this.value;
            
            municipalitySelect.innerHTML = `<option value="All">All Municipalities</option>`;
            barangaySelect.innerHTML = `<option value="All">All Barangays</option>`;
            barangaySelect.disabled = true;
            
            if (selectedProvince === "All") {
                municipalitySelect.disabled = true;
                return;
            }
            
            const munRes = await fetch(`/api/locations/municipalities?province=${encodeURIComponent(selectedProvince)}`);
            const munData = await munRes.json();
            
            if (munData.municipalities && munData.municipalities.length > 0) {
                municipalitySelect.disabled = false;
                munData.municipalities.forEach(mun => {
                    municipalitySelect.innerHTML += `<option value="${mun}">${mun}</option>`;
                });
            } else {
                municipalitySelect.disabled = true;
            }
        });

        municipalitySelect.addEventListener("change", async function() {
            const selectedProvince = provinceSelect.value;
            const selectedMunicipality = this.value;
            
            barangaySelect.innerHTML = `<option value="All">All Barangays</option>`;
            
            if (selectedMunicipality === "All") {
                barangaySelect.disabled = true;
                return;
            }
            
            let url = `/api/locations/barangays?municipality=${encodeURIComponent(selectedMunicipality)}`;
            if (selectedProvince !== "All") {
                url += `&province=${encodeURIComponent(selectedProvince)}`;
            }
            
            const brgyRes = await fetch(url);
            const brgyData = await brgyRes.json();
            
            if (brgyData.barangays && brgyData.barangays.length > 0) {
                barangaySelect.disabled = false;
                brgyData.barangays.forEach(brgy => {
                    barangaySelect.innerHTML += `<option value="${brgy}">${brgy}</option>`;
                });
            } else {
                barangaySelect.disabled = true;
            }
        });

    } catch (err) {
        console.error("Failed loading dropdowns:", err);
        alert("Failed to load location filters. Please refresh the page.");
    }
}

// FETCH REPORTS
async function fetchReports() {
    const params = new URLSearchParams();

    const filters = {
        province: "provinceFilter",
        municipality: "municipalityFilter",
        barangay: "barangayFilter",
        severity: "severityFilter",
        infestation_type: "infestationFilter",
    };

    for (let key in filters) {
        const value = document.getElementById(filters[key]).value;
        if (value !== "All") {
            params.append(key, value);
        }
    }

    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    if (start) params.append("start_date", start);
    if (end) params.append("end_date", end);

    const query = params.toString();
    const url = query ? `/api/reports?${query}` : `/api/reports`;

    const res = await fetch(url);
    return await res.json();
}

// UPDATE EVERYTHING
async function updateReports() {
    try {
        window.allReports = await fetchReports();

        updateHeatmap();
        updateMarkers();
        updateKPIs();
        updateCharts();
        updateRecentReportsTable();
        updateLastUpdated();

    } catch (err) {
        console.error("Failed to update reports:", err);
    }
}

// HEATMAP
function updateHeatmap() {
    if (heatLayer) heatLayer.remove();

    const points = window.allReports
        .filter(r => r.lat && r.lng)
        .map(r => {
            const sev = r.severity || "Pending";
            let weight = null;

            if (sev === "Critical") weight = 1.0;
            else if (sev === "High") weight = 0.8;
            else if (sev === "Moderate") weight = 0.5;
            else if (sev === "Low") weight = 0.3;

            if (weight === null) return null;
            return [r.lat, r.lng, weight];
        })
        .filter(p => p !== null);

    heatLayer = L.heatLayer(points, {
        radius: 25,
        blur: 20,
        maxZoom: 17,
    }).addTo(map);
}

// MARKERS
function updateMarkers() {
    markersLayer.clearLayers();

    window.allReports.forEach(r => {
        if (!r.lat || !r.lng) return;

        const sev = r.severity || "Pending";
        const color = SEVERITY_COLORS[sev]?.marker || '#6c757d';

        const marker = L.circleMarker([r.lat, r.lng], {
            radius: 9,
            color: color,
            fillColor: color,
            fillOpacity: 0.85,
        });

        const photoUrl = getPhotoUrl(r.photo);

        marker.bindPopup(`
            <strong>${r.barangay || ""}, ${r.municipality || ""}</strong><br>
            <small>${r.infestation_type || ""}</small><br>
            <b>Severity:</b> ${sev}<br>
            <b>Date:</b> ${r.date || ""}<br>
            <img src="${photoUrl}" 
                 style="width:120px;border-radius:5px;margin-top:4px;"
                 onerror="this.src='/static/images/snail-logo.png'">
        `);

        markersLayer.addLayer(marker);
    });
}

// GET PROPER PHOTO URL
function getPhotoUrl(photo) {
    if (!photo) return '/static/images/snail-logo.png';
    
    if (photo.startsWith('http://') || photo.startsWith('https://')) {
        return photo;
    }
    
    if (photo.startsWith('/uploads/')) {
        return photo;
    }
    
    if (!photo.startsWith('/')) {
        return '/uploads/' + photo;
    }
    
    return photo;
}

// KPIs
function updateKPIs() {
    document.getElementById("totalSightings").innerText = window.allReports.length;

    const hotspots = window.allReports.filter(r =>
        r.severity === "High" || r.severity === "Critical"
    ).length;
    document.getElementById("activeHotspots").innerText = hotspots;

    const reporters = new Set(window.allReports.map(r => r.reporter || "Unknown"));
    document.getElementById("activeReporters").innerText = reporters.size;

    document.getElementById("avgResponse").innerText = "0";
}

// CHARTS
function updateCharts() {
    const severityCount = { Low: 0, Moderate: 0, High: 0, Critical: 0, Pending: 0 };
    const barangayCount = {};
    const weekly = {};

    window.allReports.forEach(r => {
        const sev = r.severity || "Pending";
        if (severityCount[sev] !== undefined) {
            severityCount[sev]++;
        }

        if (r.barangay) {
            barangayCount[r.barangay] = (barangayCount[r.barangay] || 0) + 1;
        }

        if (r.date) {
            const day = r.date.substring(0, 10);
            weekly[day] = (weekly[day] || 0) + 1;
        }
    });

    drawSeverityChart(severityCount);
    drawBarangayChart(barangayCount);
    drawTrendChart(weekly);
}

function drawSeverityChart(data) {
    if (severityChart) severityChart.destroy();

    severityChart = new Chart(document.getElementById("severityChart"), {
        type: "pie",
        data: {
            labels: ["Pending", "Low", "Moderate", "High", "Critical"],
            datasets: [{
                data: [data.Pending, data.Low, data.Moderate, data.High, data.Critical],
                backgroundColor: [
                    SEVERITY_COLORS.Pending.marker,
                    SEVERITY_COLORS.Low.marker,
                    SEVERITY_COLORS.Moderate.marker,
                    SEVERITY_COLORS.High.marker,
                    SEVERITY_COLORS.Critical.marker
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function drawBarangayChart(data) {
    if (barangayChart) barangayChart.destroy();

    const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const labels = sorted.map(x => x[0]);
    const values = sorted.map(x => x[1]);

    barangayChart = new Chart(document.getElementById("barangayChart"), {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: 'Reports',
                data: values,
                backgroundColor: '#0d6efd'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function drawTrendChart(data) {
    if (trendChart) trendChart.destroy();

    const labels = Object.keys(data).sort();

    trendChart = new Chart(document.getElementById("trendChart"), {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: 'Daily Reports',
                data: labels.map(d => data[d]),
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// RECENT REPORTS TABLE
function updateRecentReportsTable() {
    const tbody = document.getElementById("recentReportsTable");
    tbody.innerHTML = "";

    if (!window.allReports.length) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">No reports found</td></tr>`;
        return;
    }

    const sorted = [...window.allReports].sort((a, b) => new Date(b.date) - new Date(a.date));
    const recent = sorted.slice(0, 20);

    recent.forEach(r => {
        const photoUrl = getPhotoUrl(r.photo);
        const sev = r.severity || "Pending";
        const sevClass = SEVERITY_COLORS[sev]?.badge || 'severity-pending';

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="text-center">
                <img src="${photoUrl}"
                     class="img-thumbnail shadow-sm"
                     style="width:60px;height:60px;object-fit:cover;cursor:pointer;border-radius:6px;"
                     onerror="this.src='/static/images/snail-logo.png'"
                     onclick="openPhotoModal('${photoUrl}')">
            </td>
            <td>${r.date || "-"}</td>
            <td>${r.province || "-"}</td>
            <td>${r.municipality || "-"}</td>
            <td>${r.barangay || "-"}</td>
            <td>
                <span class="badge ${sevClass}">${sev}</span>
            </td>
            <td>${r.infestation_type || "-"}</td>
            <td>${r.reporter || "Unknown"}</td>
            <td>
                <div class="action-btn-group">
                    <button 
                        class="btn-severity"
                        data-report-id="${r.id}"
                        data-current-severity="${sev}"
                        data-location="${(r.barangay || '')}, ${(r.municipality || '')}"
                        onclick="openSeverityModalFromButton(this)">
                        Set
                    </button>
                    <button 
                        class="btn-delete"
                        data-report-id="${r.id}"
                        onclick="openDeleteModal(${r.id})">
                        Delete
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// PHOTO MODAL
function openPhotoModal(photoUrl) {
    const imgUrl = photoUrl || '/static/images/snail-logo.png';
    document.getElementById("modalPhoto").src = imgUrl;
    document.getElementById("modalPhoto").onerror = function() {
        this.src = '/static/images/snail-logo.png';
    };
    new bootstrap.Modal(document.getElementById("photoModal")).show();
}

// SEVERITY MODAL
function openSeverityModalFromButton(btn) {
    const id = btn.getAttribute("data-report-id");
    const severity = btn.getAttribute("data-current-severity") || "Pending";
    const locationText = btn.getAttribute("data-location") || "";

    openSeverityModal(id, severity, locationText);
}

function openSeverityModal(reportId, currentSeverity, locationText) {
    document.getElementById("severityReportId").value = reportId;
    document.getElementById("severitySelect").value = currentSeverity || "Pending";
    document.getElementById("severityLocation").innerText = locationText;

    const errorBox = document.getElementById("severityError");
    errorBox.classList.add("d-none");
    errorBox.textContent = "";

    const modal = new bootstrap.Modal(document.getElementById("severityModal"));
    modal.show();
}

async function saveSeverity() {
    const reportId = document.getElementById("severityReportId").value;
    const severity = document.getElementById("severitySelect").value;
    const errorBox = document.getElementById("severityError");

    errorBox.classList.add("d-none");
    errorBox.textContent = "";

    if (!reportId) {
        errorBox.textContent = "Missing report ID.";
        errorBox.classList.remove("d-none");
        return;
    }

    try {
        const res = await fetch("/api/update_severity", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: reportId, severity })
        });

        const data = await res.json();

        if (data.status !== "success") {
            throw new Error(data.error || "Failed to update severity");
        }

        const modalEl = document.getElementById("severityModal");
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();

        await updateReports();

    } catch (err) {
        console.error("Failed to update severity:", err);
        errorBox.textContent = err.message || "Failed to update severity. Please try again.";
        errorBox.classList.remove("d-none");
    }
}

// DELETE MODAL
function openDeleteModal(reportId) {
    document.getElementById("deleteReportId").value = reportId;
    const modal = new bootstrap.Modal(document.getElementById("deleteModal"));
    modal.show();
}

async function confirmDelete() {
    const reportId = document.getElementById("deleteReportId").value;

    if (!reportId) {
        alert("No report ID found");
        return;
    }

    try {
        const res = await fetch(`/api/report/${reportId}`, {
            method: "DELETE"
        });

        const data = await res.json();

        if (data.status !== "success") {
            throw new Error(data.error || "Failed to delete report");
        }

        const modalEl = document.getElementById("deleteModal");
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();

        await updateReports();

        alert("Report deleted successfully!");

    } catch (err) {
        console.error("Failed to delete report:", err);
        alert("Failed to delete report: " + err.message);
    }
}

// AUTO REFRESH
function updateLastUpdated() {
    document.getElementById("lastUpdate").innerText = new Date().toLocaleTimeString();
}

function startAutoRefresh(seconds) {
    if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    if (seconds === "off") return;
    autoRefreshTimer = setInterval(updateReports, seconds * 1000);
}

// INIT
window.addEventListener("load", async () => {
    initMap();
    await loadUserProfile();
    await loadFilterDropdowns();
    await updateReports();

    document.getElementById("filterBtn").onclick = updateReports;
    document.getElementById("manualRefresh").onclick = updateReports;
    document.getElementById("profileBtn").onclick = showProfileModal;

    document.getElementById("refreshInterval").addEventListener("change", e =>
        startAutoRefresh(e.target.value)
    );
});
</script>

</body>
</html>