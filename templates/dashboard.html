<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Cache-Control" content="no-store" />
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>GASsight Dashboard</title>

<!-- PWA -->
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#dc3545">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
body { background-color: #f8faf9; }
.card { border-radius: 1rem; }
#map { height: 400px; border-radius: 1rem; }
.toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 2000; }
.high-row { background-color: #fde8e8 !important; }

.logo {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  background-color: #fff;
  border: 3px solid #e0e0e0;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  padding: 4px;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}
.logo:hover {
  transform: scale(1.08);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

/* ALERT badge */
.alert-indicator {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.15rem 0.5rem;
  border-radius: 0.5rem;
  font-weight: 700;
  background: #dc3545;
  color: #fff;
  cursor: pointer;
  animation: pulseBadge 1.4s infinite;
}
.alert-dot {
  width: 0.55rem;
  height: 0.55rem;
  border-radius: 999px;
  background: #fff;
  animation: blink 1s infinite;
}
@keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.2; } }
@keyframes pulseBadge {
  0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.45); }
  70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
  100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}
</style>
</head>

<body class="p-4">
<div class="container-fluid">
  <!-- Header -->
  <div class="d-flex align-items-center mb-4 justify-content-between flex-wrap gap-2">
    <div class="d-flex align-items-center gap-3 flex-wrap">
      <img src="{{ url_for('static', filename='images/snail-logo.jpg') }}" alt="GASsight Logo" class="logo shadow-sm">
      <div>
        <h3 class="m-0 d-flex align-items-center gap-2">
          GASsight Dashboard
          <span id="alertIndicator" class="alert-indicator d-none">
            <span class="alert-dot"></span> ALERT
          </span>
        </h3>
        <small class="text-muted">Golden Apple Snail Geo-tagging & Visualization</small>
      </div>
    </div>

    <!-- Controls -->
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div id="refreshStatus">Last updated: <span id="lastUpdate">–</span></div>
      <button id="manualRefresh" class="btn btn-sm btn-outline-primary">Refresh Now</button>
      <select id="refreshInterval" class="form-select form-select-sm" style="width:auto">
        <option value="off" selected>Auto Refresh: Off</option>
        <option value="30">Every 30s</option>
        <option value="60">Every 1min</option>
        <option value="300">Every 5min</option>
      </select>

      {% if current_user.is_authenticated %}
      <div class="dropdown">
        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
          {{ current_user.username }}
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li class="dropdown-item-text small text-muted">Signed in as <strong>{{ current_user.username }}</strong></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label fw-semibold">Barangay</label>
        <select id="barangayFilter" class="form-select"><option value="All">All</option></select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">Severity</label>
        <select id="severityFilter" class="form-select">
          <option value="All">All</option>
          <option value="Low">Low</option>
          <option value="Moderate">Moderate</option>
          <option value="High">High</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">Date Range</label>
        <input type="date" id="startDate" class="form-control mb-1" />
        <input type="date" id="endDate" class="form-control" />
      </div>
      <div class="col-md-3 text-md-start text-center">
        <button id="filterBtn" class="btn btn-success w-100">
          <i class="bi bi-funnel"></i> Apply Filter
        </button>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-4">
    <div class="col-md-3"><div class="card text-center"><div class="card-body"><h6>Total Sightings</h6><h2 id="totalSightings">0</h2></div></div></div>
    <div class="col-md-3"><div class="card text-center"><div class="card-body"><h6>Active Hotspots</h6><h2 id="activeHotspots">0</h2></div></div></div>
    <div class="col-md-3"><div class="card text-center"><div class="card-body"><h6>Active Reporters</h6><h2 id="activeReporters">0</h2></div></div></div>
    <div class="col-md-3"><div class="card text-center"><div class="card-body"><h6>Avg Response Time (hrs)</h6><h2 id="avgResponse">0</h2></div></div></div>
  </div>

  <!-- Map -->
  <div class="card mb-4 border-danger">
    <div class="card-header fw-semibold text-danger">Infestation Heatmap</div>
    <div class="card-body p-0 position-relative"><div id="map"></div></div>
  </div>

  <!-- Table -->
  <div class="card mt-4 border-light">
    <div class="card-header fw-semibold">Recent Reports</div>
    <div class="card-body table-responsive">
      <table id="reports-table" class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Date</th><th>Reporter</th><th>Location</th><th>Severity</th><th>Photo</th><th>Status</th><th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <!-- High Severity Modal -->
  <div class="modal fade" id="highModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">High Severity Hotspots</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body"><div class="list-group" id="highList"></div></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ✅ High Severity Alert System -->
<script>
function showHighAlert(highReports) {
  const alert = document.getElementById('alertIndicator');
  if (!alert) return;
  if (!highReports || highReports.length === 0) {
    alert.classList.add('d-none');
  } else {
    alert.classList.remove('d-none');
    alert.onclick = () => showHighReports(highReports);
  }
}

function showHighReports(highReports) {
  const list = document.getElementById('highList');
  list.innerHTML = '';
  highReports.forEach(r => {
    const item = document.createElement('button');
    item.className = 'list-group-item list-group-item-action d-flex align-items-center gap-3';
    item.innerHTML = `
      <img src="${r.photo || '/static/icons/icon-192.png'}" class="thumb" alt="">
      <div><strong>${r.barangay || 'Unknown'}, ${r.municipality || ''}</strong><br>
      <small>${r.date || ''} — ${r.reporter || ''}</small></div>`;
    item.addEventListener('click', () => {
      if (r.lat && r.lng && window.map) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('highModal'));
        if (modal) modal.hide();
        window.map.setView([r.lat, r.lng], 14);
      }
    });
    list.appendChild(item);
  });
  new bootstrap.Modal(document.getElementById('highModal')).show();
}

// Patch the updateReports() after dashboard.js loads
window.addEventListener('DOMContentLoaded', () => {
  const interval = setInterval(() => {
    if (typeof updateReports === 'function') {
      const original = updateReports;
      updateReports = async function() {
        await original();
        const highReports = allReports.filter(r => r.severity === 'High');
        showHighAlert(highReports);
      };
      clearInterval(interval);
    }
  }, 500);
});
</script>

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>
